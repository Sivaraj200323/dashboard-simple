<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Real-time User & Process Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
  <div id="app">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-900 to-blue-800 text-white p-6 shadow-lg">
      <h1 class="text-2xl font-bold">Real-time User & Process Analytics</h1>
    </div>

    <!-- Filters -->
    <div class="bg-white p-6 shadow">
      <div class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">MONTH</label>
            <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="All">All Months</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">YEAR</label>
            <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="All">All Years</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">WEEK</label>
            <select id="weekFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="All">All Weeks</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">USER</label>
            <select id="userFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="All">All Users</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">PROCESS</label>
            <select id="processFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="All">All Process</option>
            </select>
          </div>
        </div>
        <div class="mt-4 flex gap-3">
          <button id="applyBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md">Apply Filters</button>
          <button id="resetBtn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md">Reset</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-6">
        <div class="flex gap-8">
          <button id="userTabBtn" class="py-4 px-2 font-semibold text-blue-600 border-b-2 border-blue-600">üë§ User-Wise Report</button>
          <button id="processTabBtn" class="py-4 px-2 font-semibold text-gray-500 border-b-2 border-transparent hover:text-gray-700">‚öôÔ∏è Process-Wise Report</button>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="bg-white p-6">
      <div class="max-w-7xl mx-auto">
        <div id="loadingMsg" class="text-center py-8">
          <p class="text-gray-600">Loading data...</p>
        </div>

        <div id="userTab" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">User-Wise Performance Report</h2>
            <button class="px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-md">üì• Export to Excel</button>
          </div>

          <!-- KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-600 rounded-lg p-6 text-white">
              <div class="text-sm opacity-90 mb-2">Total Users</div>
              <div id="totalUsers" class="text-4xl font-bold">0</div>
            </div>
            <div class="bg-green-500 rounded-lg p-6 text-white">
              <div class="text-sm opacity-90 mb-2">Avg Productivity</div>
              <div id="avgProductivity" class="text-4xl font-bold">0%</div>
            </div>
            <div class="bg-pink-500 rounded-lg p-6 text-white">
              <div class="text-sm opacity-90 mb-2">Avg Quality</div>
              <div id="avgQuality" class="text-4xl font-bold">0%</div>
            </div>
            <div class="bg-cyan-500 rounded-lg p-6 text-white">
              <div class="text-sm opacity-90 mb-2">Total Hours</div>
              <div id="totalHours" class="text-4xl font-bold">0</div>
            </div>
          </div>

          <!-- Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-blue-900 text-white">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">NAME</th>
                  <th class="px-4 py-3 text-left font-semibold">PROCESS NAME</th>
                  <th class="px-4 py-3 text-center font-semibold">SUM OF # OF HOURS</th>
                  <th class="px-4 py-3 text-center font-semibold">TARGET</th>
                  <th class="px-4 py-3 text-center font-semibold">ACHIEVED</th>
                  <th class="px-4 py-3 text-center font-semibold">PRODUCTIVITY (%)</th>
                  <th class="px-4 py-3 text-center font-semibold"># OF ERRORS</th>
                  <th class="px-4 py-3 text-center font-semibold">AUDITED</th>
                  <th class="px-4 py-3 text-center font-semibold">QUALITY(%)</th>
                </tr>
              </thead>
              <tbody id="userTable" class="divide-y divide-gray-200">
              </tbody>
            </table>
          </div>
        </div>

        <div id="processTab" class="hidden">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Process-Wise Performance Report</h2>
          <div id="processTableContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ CONFIG ============
    const SHEET_ID = '1br-F3OlvJWn5TDn1Loh7WEXOtVw-o1Y7gl3kAxaMfHM';
    const SHEET_GID = '0';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

    let allData = [];
    let filteredData = [];

    function normalizeHeader(h) {
      return h.toString().trim().replace(/\s+/g, ' ').replace(/\uFEFF/g, '').toLowerCase();
    }

    function parseNum(val) {
      if (val === undefined || val === null || val === '') return null;
      const cleaned = String(val).replace(/[%\s,]+/g, '').trim();
      const n = parseFloat(cleaned);
      return isNaN(n) ? null : n;
    }

    function parseCSV(csv) {
      const rows = csv.split(/\r?\n/).filter(Boolean);
      if (rows.length === 0) return [];
      const headerLine = rows[0];
      const headers = headerLine.split(',').map(h => normalizeHeader(h));
      const dataRows = [];
      for (let i = 1; i < rows.length; i++) {
        const line = rows[i];
        const values = [];
        let cur = '';
        let inQuotes = false;
        for (let c = 0; c < line.length; c++) {
          const ch = line[c];
          if (ch === '"') { inQuotes = !inQuotes; continue; }
          if (ch === ',' && !inQuotes) { values.push(cur); cur = ''; continue; }
          cur += ch;
        }
        values.push(cur);
        const obj = {};
        headers.forEach((h, idx) => {
          obj[h] = (values[idx] !== undefined) ? values[idx].trim() : '';
        });
        dataRows.push(obj);
      }
      return dataRows;
    }

    function getField(row, preferredNames) {
      for (const name of preferredNames) {
        const key = normalizeHeader(name);
        if (row.hasOwnProperty(key) && row[key] !== '') return row[key];
      }
      return '';
    }

    async function fetchData() {
      try {
        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Network response not OK: ' + res.status);
        const csv = await res.text();
        allData = parseCSV(csv);
        console.log('Rows fetched:', allData.length);
        console.log('Sample row:', allData[0]);
        populateFilters();
        applyFilters();
        document.getElementById('loadingMsg').classList.add('hidden');
      } catch (err) {
        console.error('Error fetching CSV:', err);
        document.getElementById('loadingMsg').innerHTML = '<p class="text-red-600">Error loading data. Please check your internet connection or sheet permissions.</p>';
      }
    }

    function populateFilters() {
      const monthSet = new Set();
      const yearSet = new Set();
      const weekSet = new Set();
      const userSet = new Set();
      const processSet = new Set();

      allData.forEach(r => {
        const month = getField(r, ['Month']);
        const year = getField(r, ['Year']);
        const week = getField(r, ['Week']);
        const user = getField(r, ['User Name', 'User']);
        const process = getField(r, ['Process Name', 'Process']);

        if (month) monthSet.add(month);
        if (year) yearSet.add(year);
        if (week) weekSet.add(week);
        if (user) userSet.add(user);
        if (process) processSet.add(process);
      });

      function populateSelect(id, items) {
        const select = document.getElementById(id);
        const sorted = Array.from(items).sort();
        select.innerHTML = `<option value="All">All ${id.replace('Filter', '').charAt(0).toUpperCase() + id.replace('Filter', '').slice(1)}s</option>` +
          sorted.map(item => `<option value="${item}">${item}</option>`).join('');
      }

      populateSelect('monthFilter', monthSet);
      populateSelect('yearFilter', yearSet);
      populateSelect('weekFilter', weekSet);
      populateSelect('userFilter', userSet);
      populateSelect('processFilter', processSet);
    }

    function applyFilters() {
      const month = document.getElementById('monthFilter').value;
      const year = document.getElementById('yearFilter').value;
      const week = document.getElementById('weekFilter').value;
      const user = document.getElementById('userFilter').value;
      const process = document.getElementById('processFilter').value;

      filteredData = allData.filter(r => {
        if (month !== 'All' && getField(r, ['Month']) !== month) return false;
        if (year !== 'All' && getField(r, ['Year']) !== year) return false;
        if (week !== 'All' && getField(r, ['Week']) !== week) return false;
        if (user !== 'All' && getField(r, ['User Name', 'User']) !== user) return false;
        if (process !== 'All' && getField(r, ['Process Name', 'Process']) !== process) return false;
        return true;
      });

      updateDashboard();
    }

    function updateDashboard() {
      updateUserMetrics();
      updateUserTable();
    }

    function updateUserMetrics() {
      const uniqueUsers = new Set();
      let totalHours = 0;
      let productivityValues = [];
      let qualityValues = [];

      filteredData.forEach(r => {
        const user = getField(r, ['User Name', 'User']);
        if (user) uniqueUsers.add(user);
        
        const hours = parseNum(getField(r, ['# of Hours', 'Hours']));
        if (hours !== null) totalHours += hours;
        
        const prod = parseNum(getField(r, ['Productivity (%)', 'Productivity']));
        if (prod !== null) productivityValues.push(prod);
        
        const qual = parseNum(getField(r, ['Quality %', 'Quality']));
        if (qual !== null) qualityValues.push(qual);
      });

      const avgProd = productivityValues.length > 0 
        ? (productivityValues.reduce((a, b) => a + b, 0) / productivityValues.length).toFixed(1)
        : 0;
      
      const avgQual = qualityValues.length > 0
        ? (qualityValues.reduce((a, b) => a + b, 0) / qualityValues.length).toFixed(1)
        : 0;

      document.getElementById('totalUsers').textContent = uniqueUsers.size;
      document.getElementById('avgProductivity').textContent = `${avgProd}%`;
      document.getElementById('avgQuality').textContent = `${avgQual}%`;
      document.getElementById('totalHours').textContent = totalHours.toFixed(2);
    }

    function updateUserTable() {
      const userStats = {};

      filteredData.forEach(row => {
        const user = getField(row, ['User Name', 'User']) || 'Unknown';
        const process = getField(row, ['Process Name', 'Process']) || 'Unknown';
        const key = `${user}|${process}`;

        if (!userStats[key]) {
          userStats[key] = {
            user, process,
            hours: 0, target: 0, achieved: 0,
            productivity: [], quality: [],
            errors: 0, audited: null
          };
        }

        const hours = parseNum(getField(row, ['# of Hours', 'Hours']));
        if (hours !== null) userStats[key].hours += hours;

        const target = parseNum(getField(row, ['Target']));
        if (target !== null) userStats[key].target += target;

        const achieved = parseNum(getField(row, ['Achieved']));
        if (achieved !== null) userStats[key].achieved += achieved;

        const prod = parseNum(getField(row, ['Productivity (%)', 'Productivity']));
        if (prod !== null) userStats[key].productivity.push(prod);

        const qual = parseNum(getField(row, ['Quality %', 'Quality']));
        if (qual !== null) userStats[key].quality.push(qual);

        // Errors (Count field)
        const errors = parseNum(getField(row, ['Count', 'Errors', '# of Errors']));
        if (errors !== null) userStats[key].errors += errors;

        // Audited: only if present and numeric, otherwise remains null
        const audited = parseNum(getField(row, ['Audited']));
        if (audited !== null && userStats[key].audited === null) {
          userStats[key].audited = audited;
        }
      });

      const rows = Object.values(userStats).map(stat => {
        const avgProd = stat.productivity.length > 0
          ? (stat.productivity.reduce((a, b) => a + b, 0) / stat.productivity.length).toFixed(1)
          : '0.0';
        
        const avgQual = stat.quality.length > 0
          ? (stat.quality.reduce((a, b) => a + b, 0) / stat.quality.length).toFixed(1)
          : '0.0';

        return `
          <tr class="border-t border-gray-200 hover:bg-gray-50">
            <td class="px-4 py-3">${stat.user}</td>
            <td class="px-4 py-3 text-xs">${stat.process}</td>
            <td class="px-4 py-3 text-center">${stat.hours.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">${stat.target.toFixed(0)}</td>
            <td class="px-4 py-3 text-center font-semibold text-green-600">${stat.achieved.toFixed(0)}</td>
            <td class="px-4 py-3 text-center font-semibold text-blue-600">${avgProd}%</td>
            <td class="px-4 py-3 text-center">${stat.errors.toFixed(0)}</td>
            <td class="px-4 py-3 text-center">${stat.audited !== null ? stat.audited.toFixed(0) : '-'}</td>
            <td class="px-4 py-3 text-center font-semibold text-purple-600">${avgQual}%</td>
          </tr>
        `;
      });

      document.getElementById('userTable').innerHTML = rows.join('');
    }

    // Event listeners
    document.getElementById('applyBtn').addEventListener('click', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('monthFilter').value = 'All';
      document.getElementById('yearFilter').value = 'All';
      document.getElementById('weekFilter').value = 'All';
      document.getElementById('userFilter').value = 'All';
      document.getElementById('processFilter').value = 'All';
      applyFilters();
    });

    document.getElementById('userTabBtn').addEventListener('click', () => {
      document.getElementById('userTab').classList.remove('hidden');
      document.getElementById('processTab').classList.add('hidden');
      document.getElementById('userTabBtn').classList.add('border-blue-600', 'text-blue-600');
      document.getElementById('userTabBtn').classList.remove('border-transparent', 'text-gray-500');
      document.getElementById('processTabBtn').classList.remove('border-blue-600', 'text-blue-600');
      document.getElementById('processTabBtn').classList.add('border-transparent', 'text-gray-500');
    });

    document.getElementById('processTabBtn').addEventListener('click', () => {
      document.getElementById('userTab').classList.add('hidden');
      document.getElementById('processTab').classList.remove('hidden');
      document.getElementById('processTabBtn').classList.add('border-blue-600', 'text-blue-600');
      document.getElementById('processTabBtn').classList.remove('border-transparent', 'text-gray-500');
      document.getElementById('userTabBtn').classList.remove('border-blue-600', 'text-blue-600');
      document.getElementById('userTabBtn').classList.add('border-transparent', 'text-gray-500');
    });

    fetchData();
  </script>
</body>
</html>
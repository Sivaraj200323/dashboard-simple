<script>
/* === Minimal robust data logic ONLY (leave all HTML / CSS as-is) ===
   - normalize headers
   - parse numbers => return null when missing/non-numeric
   - Audited: only use if numeric; otherwise treat as null (exclude from audited/quality calcs)
   - Count: treated strictly as Error Count (missing -> 0)
   - date dropdown and CSV parsing robust to quoted commas
*/

const SHEET_ID = '1br-F3OlvJWn5TDn1Loh7WEXOtVw-o1Y7gl3kAxaMfHM';
const SHEET_GID = '0';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

let allData = [];
let filteredData = [];
let productivityChart = null;
let targetChart = null;

function normalizeHeader(h) {
  return String(h || '').trim().replace(/\uFEFF/g, '').replace(/\s+/g,' ').toLowerCase();
}

// parseNum: returns number OR null (important distinction)
function parseNum(val) {
  if (val === undefined || val === null) return null;
  const s = String(val).trim();
  if (s === '') return null;
  const cleaned = s.replace(/[%\s,]+/g,'').trim();
  const n = parseFloat(cleaned);
  return isNaN(n) ? null : n;
}

// CSV line splitter (handles quoted commas)
function splitCsvLine(line) {
  const vals = [];
  let cur = '', inQuotes = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"') { inQuotes = !inQuotes; continue; }
    if (ch === ',' && !inQuotes) { vals.push(cur); cur = ''; continue; }
    cur += ch;
  }
  vals.push(cur);
  return vals;
}

function parseCSV(csv) {
  const lines = csv.split(/\r?\n/).filter(Boolean);
  if (!lines.length) return [];
  const headers = splitCsvLine(lines[0]).map(normalizeHeader);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const values = splitCsvLine(lines[i]);
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = (values[idx] !== undefined) ? values[idx].trim() : '';
    });
    rows.push(obj);
  }
  return rows;
}

// flexible field getter (tries several possible header names)
function getField(row, names) {
  for (const n of names) {
    const k = normalizeHeader(n);
    if (k in row && row[k] !== '') return row[k];
  }
  // fallback: try partial matches
  for (const k in row) {
    if (names[0].toLowerCase().includes('date') && k.includes('date')) return row[k];
    if (names[0].toLowerCase().includes('user') && k.includes('user')) return row[k];
  }
  return '';
}

// Audited: return numeric value or null (DO NOT fallback to Count)
function getAuditedValue(row) {
  return parseNum(getField(row, ['Audited']));
}
// Count: error count. Return 0 if missing
function getCountValue(row) {
  return parseNum(getField(row, ['Count'])) || 0;
}

// fetch CSV and initialize
async function fetchData() {
  try {
    const res = await fetch(CSV_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Network response not OK: ' + res.status);
    const csv = await res.text();
    allData = parseCSV(csv);

    console.log('Fetched rows:', allData.length);
    document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;

    populateFilters();
    filterData();

    const loading = document.getElementById('loading');
    if (loading) loading.classList.add('hidden');
    const mcont = document.getElementById('metricsContainer');
    if (mcont) mcont.classList.remove('hidden');
  } catch (err) {
    console.error('CSV fetch error', err);
    const lt = document.getElementById('loadingText');
    if (lt) lt.innerHTML = `<span style="color:#ff6b6b">Error loading data. Check sheet permissions or URL.</span>`;
  }
}

function populateFilters() {
  const monthSet = new Set();
  const userSet = new Set();
  allData.forEach(r => {
    const m = getField(r, ['Month']);
    const u = getField(r, ['User Name','User']);
    if (m) monthSet.add(m);
    if (u) userSet.add(u);
  });
  const monthArr = ['All', ...Array.from(monthSet)];
  const userArr = ['All', ...Array.from(userSet)];

  const monthFilter = document.getElementById('monthFilter');
  const userFilter = document.getElementById('userFilter');
  if (monthFilter) monthFilter.innerHTML = monthArr.map(m=>`<option value="${m}">${m}</option>`).join('');
  if (userFilter) userFilter.innerHTML = userArr.map(u=>`<option value="${u}">${u}</option>`).join('');

  updateDateFilter();
}

function updateDateFilter() {
  const selMonth = document.getElementById('monthFilter') ? document.getElementById('monthFilter').value : 'All';
  const selUser = document.getElementById('userFilter') ? document.getElementById('userFilter').value : 'All';
  let rows = allData.slice();
  if (selMonth && selMonth !== 'All') rows = rows.filter(r => (getField(r,['Month'])||'') === selMonth);
  if (selUser && selUser !== 'All') rows = rows.filter(r => (getField(r,['User Name','User'])||'') === selUser);

  const dateSet = new Set();
  rows.forEach(r => {
    const d = getField(r, ['Date']);
    if (d) dateSet.add(d);
  });

  const dates = ['', ...Array.from(dateSet).sort((a,b)=> (Date.parse(a)||Date.parse(a.replace(/-/g,' '))||0) - (Date.parse(b)||Date.parse(b.replace(/-/g,' '))||0))];
  const dateFilter = document.getElementById('dateFilter');
  if (dateFilter) {
    const cur = dateFilter.value;
    dateFilter.innerHTML = dates.map(d=>`<option value="${d}">${d || 'All Dates'}</option>`).join('');
    if (dates.includes(cur)) dateFilter.value = cur; else dateFilter.value = '';
  }
}

function filterData() {
  const selectedMonth = document.getElementById('monthFilter') ? document.getElementById('monthFilter').value : 'All';
  const selectedDate = document.getElementById('dateFilter') ? document.getElementById('dateFilter').value : '';
  const selectedUser = document.getElementById('userFilter') ? document.getElementById('userFilter').value : 'All';

  filteredData = allData.filter(r => {
    const month = getField(r,['Month']) || '';
    const date = getField(r,['Date']) || '';
    const user = getField(r, ['User Name','User']) || '';
    if (selectedMonth && selectedMonth !== 'All' && month !== selectedMonth) return false;
    if (selectedDate && selectedDate !== '' && date !== selectedDate) return false;
    if (selectedUser && selectedUser !== 'All' && user !== selectedUser) return false;
    return true;
  });

  updateDashboard();
}

function updateDashboard() {
  updateMetrics();
  updateCharts();
  updateTable();
  updateDateFilter();
}

function updateMetrics() {
  // Users
  const users = new Set(filteredData.map(r=> getField(r, ['User Name','User'])).filter(Boolean));
  const elUsers = document.getElementById('metricUsers');
  if (elUsers) elUsers.textContent = users.size;

  // Hours
  const hours = filteredData.reduce((s,r)=> s + (parseNum( getField(r,['# of Hours','Hours'])) || 0), 0);
  const elHours = document.getElementById('metricHours'); if (elHours) elHours.textContent = hours.toFixed(1);

  // Avg Productivity (include only rows with numeric productivity)
  const pList = filteredData.map(r=>parseNum(getField(r,['Productivity (%)','Productivity']))).filter(v=>v!==null);
  const avgP = pList.length ? (pList.reduce((a,b)=>a+b,0)/pList.length).toFixed(1) : 0;
  const elProd = document.getElementById('metricProductivity'); if (elProd) elProd.textContent = `${avgP}%`;

  // Error Count = sum of Count (missing => 0)
  const errors = filteredData.reduce((s,r)=> s + (parseNum(getField(r,['Count'])) || 0), 0);
  const elErr = document.getElementById('metricErrors'); if (elErr) elErr.textContent = errors.toFixed(0);

  // Audited: sum ONLY numeric audited values (rows without audited excluded)
  const auditedVals = filteredData.map(r=>getAuditedValue(r)).filter(v=>v!==null);
  const totalAudited = auditedVals.length ? auditedVals.reduce((a,b)=>a+b,0) : null;
  const elAud = document.getElementById('metricAudited');
  if (elAud) elAud.textContent = (totalAudited === null ? '-' : totalAudited.toFixed(0));

  // Avg Quality: include only rows where BOTH Quality numeric AND Audited numeric
  const qualPairs = filteredData.map(r=> {
    const q = parseNum(getField(r,['Quality %','Quality']));
    const a = getAuditedValue(r);
    return {q,a};
  }).filter(x=> x.q !== null && x.a !== null);
  const avgQual = qualPairs.length ? (qualPairs.reduce((s,x)=> s + x.q,0)/qualPairs.length).toFixed(1) : 0;
  const elQ = document.getElementById('metricQuality'); if (elQ) elQ.textContent = `${avgQual}%`;
}

function updateCharts() {
  // build date series from filteredData
  const dates = Array.from(new Set(filteredData.map(r => getField(r,['Date'])))).filter(Boolean)
    .sort((a,b)=> (Date.parse(a)||Date.parse(a.replace(/-/g,' '))||0) - (Date.parse(b)||Date.parse(b.replace(/-/g,' '))||0));

  const prodSeries = dates.map(date => {
    const day = filteredData.filter(r => getField(r,['Date']) === date);
    const pvals = day.map(r => parseNum(getField(r,['Productivity (%)','Productivity']))).filter(v=>v!==null);
    const qvals = day.map(r => parseNum(getField(r,['Quality %','Quality']))).filter(v=>v!==null);
    const avgP = pvals.length ? (pvals.reduce((a,b)=>a+b,0)/pvals.length) : 0;
    const avgQ = qvals.length ? (qvals.reduce((a,b)=>a+b,0)/qvals.length) : 0;
    return {date, productivity: avgP.toFixed(1), quality: avgQ.toFixed(1)};
  });

  const targetSeries = dates.map(date => {
    const day = filteredData.filter(r => getField(r,['Date']) === date);
    const t = day.reduce((s,r) => s + (parseNum(getField(r,['Target'])) || 0), 0);
    const a = day.reduce((s,r) => s + (parseNum(getField(r,['Achieved'])) || 0), 0);
    return {date, target:t, achieved:a};
  });

  // draw charts (Chart.js) - guard in case canvas missing
  const pCanvas = document.getElementById('productivityChart');
  if (pCanvas) {
    const ctx1 = pCanvas.getContext('2d');
    if (productivityChart) productivityChart.destroy();
    productivityChart = new Chart(ctx1, {
      type:'line',
      data:{
        labels: prodSeries.map(d=>d.date),
        datasets:[
          { label:'Productivity %', data: prodSeries.map(d=>d.productivity), borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.08)', tension:0.4 },
          { label:'Quality %', data: prodSeries.map(d=>d.quality), borderColor:'#f093fb', backgroundColor:'rgba(240,147,251,0.08)', tension:0.4 }
        ]
      },
      options:{ responsive:true, maintainAspectRatio:true }
    });
  }

  const tCanvas = document.getElementById('targetChart');
  if (tCanvas) {
    const ctx2 = tCanvas.getContext('2d');
    if (targetChart) targetChart.destroy();
    targetChart = new Chart(ctx2, {
      type:'bar',
      data:{
        labels: targetSeries.map(d=>d.date),
        datasets:[
          { label:'Target', data: targetSeries.map(d=>d.target) },
          { label:'Achieved', data: targetSeries.map(d=>d.achieved) }
        ]
      },
      options:{ responsive:true, maintainAspectRatio:true }
    });
  }
}

function updateTable() {
  const tbody = document.getElementById('dataTable');
  if (!tbody) return;
  const rowsHtml = filteredData.map(r => {
    const name = getField(r,['User Name','User']);
    const project = getField(r,['Project Name','Project','Process Type']);
    const hours = parseNum(getField(r,['# of Hours','Hours'])) || 0;
    const target = parseNum(getField(r,['Target'])) || 0;
    const achieved = parseNum(getField(r,['Achieved'])) || 0;
    const productivity = parseNum(getField(r,['Productivity (%)','Productivity'])) || 0;
    const errors = getCountValue(r) || 0;
    const audited = getAuditedValue(r);
    const quality = parseNum(getField(r,['Quality %','Quality']));
    return `<tr>
      <td>${name}</td><td>${project}</td>
      <td style="text-align:center">${hours}</td>
      <td style="text-align:center">${target}</td>
      <td style="text-align:center">${achieved}</td>
      <td style="text-align:center">${productivity===null? '': productivity + '%'}</td>
      <td style="text-align:center">${errors}</td>
      <td style="text-align:center">${audited===null? '': audited}</td>
      <td style="text-align:center">${quality===null? '': quality + '%'}</td>
    </tr>`;
  }).join('');

  tbody.innerHTML = rowsHtml || '<tr><td colspan="9" style="text-align:center;padding:20px;color:#94a3b8">No records</td></tr>';
}

// wire events (assumes the original HTML has these IDs)
document.getElementById('monthFilter')?.addEventListener('change', filterData);
document.getElementById('dateFilter')?.addEventListener('change', filterData);
document.getElementById('userFilter')?.addEventListener('change', filterData);
document.getElementById('applyFilters')?.addEventListener('click', filterData);
document.getElementById('resetFilters')?.addEventListener('click', ()=> {
  if (document.getElementById('monthFilter')) document.getElementById('monthFilter').value = 'All';
  if (document.getElementById('userFilter')) document.getElementById('userFilter').value = 'All';
  if (document.getElementById('dateFilter')) document.getElementById('dateFilter').value = '';
  filterData();
});

// fetch now
fetchData();
</script>
